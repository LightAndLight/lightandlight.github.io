<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preload" href="/fonts/SourceSerif4/SourceSerif4-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/SourceSans3/SourceSans3-Regular.woff2" as="font" type="font/woff2" crossorigin>

  <link rel="stylesheet" href="/res/fonts.css">
  <link rel="stylesheet" href="/res/style.css">

  <!-- defer non-critical stylesheet -->
  <link href="/res/syntax.css" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/res/syntax.css"></noscript>

  

  

  

  
  <title>Troubleshooting LightDM's test mode - blog.ielliott.io</title>
  

  <link rel="canonical" href="https://blog.ielliott.io/troubleshooting-lightdms-test-mode">
<link rel="alternate" type="application/atom+xml" title="blog.ielliott.io" href="/feed.xml">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="blog.ielliott.io">
<meta property="og:url" content="https://blog.ielliott.io/troubleshooting-lightdms-test-mode">
<meta property="og:title" content="Troubleshooting LightDM's test mode">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Troubleshooting LightDM's test mode">


<meta name="author" content="Isaac Elliott">
<meta name="description" content="Recently I've been tweaking the appearance of my desktop environment,
which consists of XMonad and Taffybar,
with LightDM as the display manager,
all tied together using NixOS and home-manager.">
<meta property="og:description" content="Recently I've been tweaking the appearance of my desktop environment,
which consists of XMonad and Taffybar,
with LightDM as the display manager,
all tied together using NixOS and home-manager.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-08-03T00:00+00:00">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline":"Troubleshooting LightDM's test mode",
  "author": {
    "@type":"Person",
    "name":"Isaac Elliott"
  },
  "datePublished":"2024-08-03T00:00+00:00",
  "dateModified":"2024-08-03T00:00+00:00",
  "description":"Recently I've been tweaking the appearance of my desktop environment,
which consists of XMonad and Taffybar,
with LightDM as the display manager,
all tied together using NixOS and home-manager.",
  "mainEntityOfPage": {
    "@type":"WebPage",
    "@id":"https://blog.ielliott.io/troubleshooting-lightdms-test-mode"
  },
  "url": "https://blog.ielliott.io/troubleshooting-lightdms-test-mode"
}
</script>
</head>

<body>
  <header>
    <h1><a href="/">I E</a></h1>
    <nav>
      <ol>
        <li><a href="/">Home</a>
        <li><a href="/about">About</a>
        <li><a href="/resources">Resources</a>
      </ol>
    </nav>
  </header>

  <main>
    

    <article>
  <header>
    <h1>Troubleshooting LightDM's test mode</h1>
    <p class="post-metadata">
       3 August, 2024
      
    </p>
  </header>
  <div id="toc">
<h3>Contents</h3>
<ul>
<li><a href="#summary">Summary</a>
<ul>
<li><a href="#symptoms">Symptoms</a></li>
<li><a href="#solution">Solution</a></li>
</ul></li>
<li><a href="#details">Details</a></li>
</ul>
</div>
<p>Recently I’ve been tweaking the appearance of <a href="https://github.com/LightAndLight/personal-configs">my desktop environment</a>,
which consists of <a href="https://xmonad.org/">XMonad</a> and <a href="https://github.com/taffybar/taffybar">Taffybar</a>,
with <a href="https://github.com/canonical/lightdm">LightDM</a> as the display manager,
all tied together using <a href="https://nixos.org/">NixOS</a> and <a href="https://github.com/nix-community/home-manager">home-manager</a>.</p>
<p>Taffybar was very easy to customise because it uses a single CSS file.
XMonad was also not too bad, but needs a custom <a href="https://wiki.archlinux.org/title/Xorg#Composite">X compositor</a> to get really nice results (I’m using <a href="https://github.com/yshui/picom">picom</a>).
LightDM is the last thing on my list.</p>
<p>If I’m going to be tweaking my <a href="https://wiki.archlinux.org/title/LightDM#Greeter">greeter</a>’s appearance,
I don’t want to repeatedly log in and out to test it.
I’d like to preview the changes in a window while I’ve got my editor open in another.</p>
<p><a href="https://wiki.archlinux.org/title/LightDM#Testing">LightDM on ArchWiki</a> says to run <code>lightdm --test-mode</code>, but this didn’t work for me.</p>
<h2 id="summary"><a href="#summary">Summary</a></h2>
<h3 id="symptoms"><a href="#symptoms">Symptoms</a></h3>
<ul>
<li><p><code>lightdm --test-mode --debug</code> failed</p>
<ul>
<li>Greeter logs (<code>.cache/lightdm/log/seat0-greeter.log</code>) show <code>Failed to open PAM session: Authentication failure</code></li>
</ul></li>
<li><p><code>sudo -u lightdm lightdm --test-mode --debug</code> reports <code>Failed to get D-Bus connection</code></p>
<ul>
<li><p>X logs (<code>/var/lib/lightdm/.cache/lightdm/log/x-1.log</code>) contain</p>
<pre><code>Authorization required, but no authorization protocol specified


Xephyr cannot open host display. Is DISPLAY set?</code></pre></li>
</ul></li>
</ul>
<h3 id="solution"><a href="#solution">Solution</a></h3>
<p>Run <code>xhost +SI:localuser:lightdm</code> to allow the <code>lightdm</code> user to connect to the X user,
then run <code>sudo -u lightdm lightdm --test-mode</code>.</p>
<h2 id="details"><a href="#details">Details</a></h2>
<p>When I ran <code>lightdm --test-mode</code> a small black window briefly appeared and then the program exited with status 1.
I added the <code>--debug</code> flag, and saw that a subprocess had failed:</p>
<pre><code>$ lightdm --test-mode --debug
...
[+0.07s] DEBUG: Session pid=29039: Started with service 'lightdm-greeter', username '{my username}'
[+0.08s] DEBUG: Session pid=29039: Authentication complete with return value 0: Success
[+0.08s] DEBUG: Seat seat0: Session authenticated, running command
[+0.08s] DEBUG: Session pid=29039: Not setting XDG_VTNR
[+0.08s] DEBUG: Session pid=29039: Running command /nix/store/ikwkdnyzd8xflr3j7cabmy6vr3srvp3j-lightdm-gtk-greeter-2.0.8/bin/lightdm-gtk-greeter
[+0.08s] DEBUG: Creating shared data directory /var/lib/lightdm-data/{my username}
[+0.08s] WARNING: Could not create user data directory /var/lib/lightdm-data/{my username}: Error creating directory /var/lib/lightdm-data/{my username}: Permission denied
[+0.08s] DEBUG: Session pid=29039: Logging to /home/{my username}/.cache/lightdm/log/seat0-greeter.log
[+0.08s] DEBUG: Greeter closed communication channel
[+0.08s] DEBUG: Session pid=29039: Exited with return value 1
...</code></pre>
<p>The output also told me where the subprocess stored its logs, so I checked there:</p>
<pre><code>$ cat /home/{my username}/.cache/lightdm/log/seat0-greeter.log
Failed to open PAM session: Authentication failure</code></pre>
<p>A <a href="https://en.wikipedia.org/wiki/Linux_PAM">PAM</a> error.</p>
<p><code>man pam</code> says that PAM errors are often logged to <code>syslog</code>, so I checked the <a href="https://wiki.archlinux.org/title/Systemd/Journal">systemd journal</a>:</p>
<pre><code>$ journalctl --user -b -r -g pam -n 10
Aug 03 11:22:44 {my hostname} lightdm[29039]: pam_systemd(lightdm-greeter:session): Failed to create session: Access denied
Aug 03 11:22:44 {my hostname} lightdm[29039]: pam_succeed_if(lightdm-greeter:session): requirement &quot;user = lightdm&quot; not met by user &quot;{my username}&quot;
...</code></pre>
<p>It seems that LightDM doesn’t like being run as a normal user, and would rather be run as the <code>lightdm</code> user.
I found that the LightDM README actually has <a href="https://github.com/canonical/lightdm?tab=readme-ov-file#display-setup-script">a note</a> about using <code>sudo -u lightdm</code> for <code>--test-mode</code>,
so I tried it:</p>
<pre><code>$ sudo -u lightdm lightdm --test-mode --debug
[+0.00s] DEBUG: Logging to /var/lib/lightdm/.cache/lightdm/log/lightdm.log
[+0.00s] DEBUG: Starting Light Display Manager 1.32.0, UID=78 PID=30100
...
[+0.00s] DEBUG: Loading configuration from /etc/lightdm/lightdm.conf
[+0.00s] DEBUG: Running in user mode
[+0.00s] DEBUG: Using Xephyr for X servers
...
[+0.00s] DEBUG: Using D-Bus name org.freedesktop.DisplayManager
...
[+0.00s] DEBUG: Seat seat0: Starting
[+0.00s] DEBUG: Seat seat0: Creating greeter session
[+0.00s] DEBUG: Loading users from org.freedesktop.Accounts
[+0.00s] DEBUG: Seat seat0: Creating display server of type x
[+0.00s] DEBUG: Seat seat0: Starting local X display
[+0.01s] DEBUG: XServer 1: Logging to /var/lib/lightdm/.cache/lightdm/log/x-1.log
[+0.01s] DEBUG: XServer 1: Writing X server authority to /var/lib/lightdm/.cache/lightdm/run/root/:1
[+0.01s] DEBUG: XServer 1: Launching X Server
[+0.01s] DEBUG: Launching process 30107: /run/current-system/sw/bin/Xephyr :1 -seat seat0 -auth /var/lib/lightdm/.cache/lightdm/run/root/:1 -nolisten tcp
[+0.01s] DEBUG: XServer 1: Waiting for ready signal from X server :1
Failed to get D-Bus connection</code></pre>
<p>That didn’t work either.
I checked the X server logs that were generated:</p>
<pre><code>$ sudo cat /var/lib/lightdm/.cache/lightdm/log/x-1.log
Authorization required, but no authorization protocol specified


Xephyr cannot open host display. Is DISPLAY set?</code></pre>
<p>I didn’t undertand what this meant. Is <code>DISPLAY</code> set?</p>
<pre><code>$ sudo -u lightdm env | rg DISPLAY
DISPLAY=:0</code></pre>
<p>It is. I was stumped.</p>
<p>After lots of searching and browsing,
a <a href="https://kagi.com">Kagi search</a> for <code>lightdm --test-mode</code> turned up <a href="https://forums.raspberrypi.com/viewtopic.php?t=220324">Problems with lightdm test mode - Raspberry Pi Forums</a>,
which lead to <a href="https://ubuntuhandbook.org/index.php/2014/05/capture-your-lightdm-login-screen-in-ubuntu-14-04/">Capture Your LightDM Login Screen in Ubuntu Unity | UbuntuHandbook</a>,
which uses a variation of <code>sudo -u lightdm lightdm --test-mode</code>
after calling <code>xhost +SI:localuser:lightdm</code>.</p>
<p><code>man xhost</code> says:</p>
<blockquote>
<p>The xhost program is used to add and delete host names or user names to the list allowed to make connections to the X server.
In the case of hosts, this provides a rudimentary form of privacy control and security.
It is only sufficient for a workstation (single user) environment, although it does limit the worst abuses.
Environments which require more sophisticated measures should implement the user-based mechanism or use the hooks in the protocol for passing other authentication data to the server.</p>
</blockquote>
<p>That seemed promising.</p>
<pre><code>$ xhost +SI:localuser:lightdm
localuser:lightdm being added to access control list</code></pre>
<p>Running LightDM again worked!</p>
<pre><code>$ sudo -u lightdm lightdm --test-mode --debug
...
[+0.09s] DEBUG: Session pid=40112: Started with service 'lightdm-greeter', username 'lightdm'
[+0.09s] DEBUG: Session pid=40112: Authentication complete with return value 0: Success
[+0.09s] DEBUG: Seat seat0: Session authenticated, running command
[+0.09s] DEBUG: Session pid=40112: Not setting XDG_VTNR
[+0.09s] DEBUG: Session pid=40112: Running command /nix/store/ikwkdnyzd8xflr3j7cabmy6vr3srvp3j-lightdm-gtk-greeter-2.0.8/bin/lightdm-gtk-greeter
[+0.09s] DEBUG: Creating shared data directory /var/lib/lightdm-data/lightdm
[+0.09s] DEBUG: Session pid=40112: Logging to /var/lib/lightdm/.cache/lightdm/log/seat0-greeter.log
[+0.16s] DEBUG: Greeter connected version=1.32.0 api=1 resettable=false
[+0.35s] DEBUG: Greeter start authentication
[+0.35s] DEBUG: Session: Not setting XDG_VTNR
[+0.35s] DEBUG: Session pid=40144: Started with service 'lightdm', username '(null)'
[+0.35s] DEBUG: Session pid=40144: Got 1 message(s) from PAM
[+0.35s] DEBUG: Prompt greeter with 1 message(s)</code></pre>
<p>My greeter appeared in a small window.
I don’t know what the fundamental problem was; I know basically nothing about this area of Linux.
I’ll probably learn more about it one day.
For now I’m content with having fixed my issue.</p>
  <p class="post-navigation">
  
  <a href="/2023-project-review" title="Previous post: 2023 Project Review">← 2023 Project Review</a>
  

  
  <a href="/per-project-nix-substituters" title="Next post: Per-project Nix substituters">Per-project Nix substituters →</a>
  
</p>

</article>

  </main>

  <footer>
    <span>Isaac Elliott</span>

    <ol>
      <li><a class="footer-item-link" href="https://github.com/lightandlight">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M208.31 75.68A59.78 59.78 0 0 0 202.93 28a8 8 0 0 0-6.93-4 59.75 59.75 0 0 0-48 24h-24a59.75 59.75 0 0 0-48-24 8 8 0 0 0-6.93 4 59.78 59.78 0 0 0-5.38 47.68A58.14 58.14 0 0 0 56 104v8a56.06 56.06 0 0 0 48.44 55.47A39.8 39.8 0 0 0 96 192v8H72a24 24 0 0 1-24-24 40 40 0 0 0-40-40 8 8 0 0 0 0 16 24 24 0 0 1 24 24 40 40 0 0 0 40 40h24v16a8 8 0 0 0 16 0v-40a24 24 0 0 1 48 0v40a8 8 0 0 0 16 0v-40a39.8 39.8 0 0 0-8.44-24.53A56.06 56.06 0 0 0 216 112v-8a58.14 58.14 0 0 0-7.69-28.32M200 112a40 40 0 0 1-40 40h-48a40 40 0 0 1-40-40v-8a41.74 41.74 0 0 1 6.9-22.48 8 8 0 0 0 1.1-7.69 43.8 43.8 0 0 1 .79-33.58 43.88 43.88 0 0 1 32.32 20.06 8 8 0 0 0 6.71 3.69h32.35a8 8 0 0 0 6.74-3.69 43.87 43.87 0 0 1 32.32-20.06 43.8 43.8 0 0 1 .77 33.58 8.09 8.09 0 0 0 1 7.65 41.7 41.7 0 0 1 7 22.52Z"></path></svg>
        GitHub
      </a>

      <li><a class="footer-item-link" href="mailto:blog@id.ielliott.io">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M224 48H32a8 8 0 0 0-8 8v136a16 16 0 0 0 16 16h176a16 16 0 0 0 16-16V56a8 8 0 0 0-8-8m-20.57 16L128 133.15 52.57 64ZM216 192H40V74.19l82.59 75.71a8 8 0 0 0 10.82 0L216 74.19z"></path></svg>
        Email
      </a>

      <li><a class="footer-item-link" href="/feed.xml">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M224 192a8 8 0 0 1-16 0c0-79.4-64.6-144-144-144a8 8 0 0 1 0-16c88.22 0 160 71.78 160 160M64 104a8 8 0 0 0 0 16 72.08 72.08 0 0 1 72 72 8 8 0 0 0 16 0 88.1 88.1 0 0 0-88-88m4 72a12 12 0 1 0 12 12 12 12 0 0 0-12-12"></path></svg>
        Feed
      </a>
    </ol>
  </footer>

  
</body>

</html>
