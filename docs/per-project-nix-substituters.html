<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-04K8QC3TXH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-04K8QC3TXH');
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link rel="stylesheet" href="/res/style.css">
  <link rel="stylesheet" href="/res/syntax.css">

  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400italic|Source+Serif+Pro|Source+Code+Pro:400" type="text/css">

  

  <script src="https://unpkg.com/feather-icons"></script>
  <script src="/res/script.js"></script>

  
  <title>Per-project Nix substituters - blog.ielliott.io</title>
  

  <meta property="og:locale" content="en_US">
<meta property="og:site_name" content="blog.ielliott.io">
<link rel="canonical" href="https://blog.ielliott.io/per-project-nix-substituters">
<meta property="og:url" content="https://blog.ielliott.io/per-project-nix-substituters">
<meta property="og:title" content="Per-project Nix substituters">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Per-project Nix substituters">

<meta name="author" content="Isaac Elliott">
<meta name="description" content="A lot of Nix projects end up with their own binary cache (also known as a " substituter"). Nix can be quite slow when it's configured to use many project-specific substituters, because it queries them all when checking if it needs to build a derivation. In a specific project, most of the other substituters Nix knows about are irrelevant, and querying them is wasted effort. My solution is to only enable https: cache.nixos.org globally, and to selectively enable other substituters while I'm working on a project that needs them. Here's how I do it.">
<meta property="og:description" content="A lot of Nix projects end up with their own binary cache (also known as a " substituter"). Nix can be quite slow when it's configured to use many project-specific substituters, because it queries them all when checking if it needs to build a derivation. In a specific project, most of the other substituters Nix knows about are irrelevant, and querying them is wasted effort. My solution is to only enable https: cache.nixos.org globally, and to selectively enable other substituters while I'm working on a project that needs them. Here's how I do it.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-08-10T00:00+00:00">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline":"Per-project Nix substituters",
  "author": {
    "@type":"Person",
    "name":"Isaac Elliott"
  },
  "datePublished":"2024-08-10T00:00+00:00",
  "dateModified":"2024-08-10T00:00+00:00",
  "description":"A lot of Nix projects end up with their own binary cache (also known as a "substituter").
Nix can be quite slow when it's configured to use many project-specific substituters,
because it queries them all when checking if it needs to build a derivation. In a specific
project, most of the other substituters Nix knows about are irrelevant, and querying them
is wasted effort. My solution is to only enable https://cache.nixos.org globally, and
to selectively enable other substituters while I'm working on a project that needs them.
Here's how I do it.",
  "mainEntityOfPage": {
    "@type":"WebPage",
    "@id":"https://blog.ielliott.io/per-project-nix-substituters"
  },
  "url": "https://blog.ielliott.io/per-project-nix-substituters"
}
</script>
</head>

<body>
  <header>
  <h1 class="centered large">I E</h1>
</header>
  <nav>
  <a href="/" onmouseover="navColor(true)" onmouseout="navColor(false)">Home</a>
  &nbsp;
  &nbsp;
  <a href="/about" onmouseover="navColor(true)" onmouseout="navColor(false)">About</a>
  &nbsp;
  &nbsp;
  <a href="/resources" onmouseover="navColor(true)" onmouseout="navColor(false)">Resources</a>
</nav>

  <section>
    

    <article>
  <h1>Per-project Nix substituters</h1>
  <p class="date">10 August, 2024</p>
  <div id="toc" style="float: right;">
<h3>Contents</h3>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#without-flakes">Without Flakes</a></li>
<li><a href="#with-flakes">With Flakes</a></li>
</ul>
</div>
<p>A lot of Nix projects end up with their own binary cache (also known as a “substituter”).
Nix can be quite slow when it’s configured to use many project-specific substituters<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>,
because it queries them all when checking if it needs to build a derivation. In a specific
project, most of the other substituters Nix knows about are irrelevant, and querying them
is wasted effort. My solution is to only enable <a href="https://cache.nixos.org" class="uri">https://cache.nixos.org</a> globally, and
to selectively enable other substituters while I’m working on a project that needs them.
Here’s how I do it.</p>
<h2 id="setup"><a href="#setup">Setup</a></h2>
<p>In <code>configuration.nix</code>, set the system’s trusted substituters<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>nix.settings.trusted<span class="op">-</span>substituters = <span class="op">[</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;https://cache.nixos.org/&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-1&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-2&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;...&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-N&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>nix.settings.trusted<span class="op">-</span>public<span class="op">-</span>keys = <span class="op">[</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-1&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-2&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;...&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-N&quot;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span></code></pre></div>
<p>And set Nix’s default substituter:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>nix.settings.substituters = <span class="op">[</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;https://cache.nixos.org/&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span></code></pre></div>
<p>By default, only the substituters in <code>substituters</code> will be used by Nix.
<code>trusted-substituters</code> lists the substituters that regular users are allowed to use in Nix builds.</p>
<h2 id="without-flakes"><a href="#without-flakes">Without Flakes</a></h2>
<p>To enable other substituters, use the <code>NIX_CONF</code> environment variable
with the <code>extra-substituters</code><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a><sup>,</sup><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> setting:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">NIX_CONF</span><span class="op">=</span><span class="st">&quot;extra-substituters = substituter-42&quot;</span></span></code></pre></div>
<p>Or use <code>substituters</code> to override the system’s substituters:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">NIX_CONF</span><span class="op">=</span><span class="st">&quot;substituters = substituter-42&quot;</span></span></code></pre></div>
<p>If the substituters named in these local settings aren’t defined in the <code>trusted-substituters</code>
system setting,
then Nix will ignore them and print the following message:</p>
<pre><code>warning: ignoring untrusted substituter '{substituter URL}', you are not a trusted user.</code></pre>
<p>I use <a href="https://direnv.net/">direnv</a> to automatically set and unset <code>NIX_CONF</code> by putting the <code>export NIX_CONF=...</code>
command inside a <code>.envrc</code> in the project root.</p>
<h2 id="with-flakes"><a href="#with-flakes">With Flakes</a></h2>
<p>The <code>nixConfig</code> attribute can be used to set Nix configuration from inside a Flake<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixConfig</span>.<span class="va">extra-substituters</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;substituter-42&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>By default, Nix will ask for permission to use the config specified by the Flake.
I use <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a> to automatically load and unload <a href="https://nix.dev/manual/nix/2.18/command-ref/new-cli/nix3-develop">Nix develop shells</a> when switching projects,
and the permission prompt <a href="https://github.com/direnv/direnv/issues/1022">breaks direnv on my shell</a>.</p>
<p>To work around this, I enable the <a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-accept-flake-config"><code>accept-flake-config</code></a> Nix option in my <code>configuration.nix</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nix.extraOptions = <span class="st">''</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="st">  experimental-features = nix-command flakes</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="st">  accept-flake-config = true</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">''</span>;</span></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Some relevant discussions:</p>
<ul>
<li><a href="https://discourse.nixos.org/t/a-common-public-nix-cache/26998#many-caches-are-bad-2" class="uri">https://discourse.nixos.org/t/a-common-public-nix-cache/26998#many-caches-are-bad-2</a></li>
<li><a href="https://github.com/NixOS/nix/issues/3019" class="uri">https://github.com/NixOS/nix/issues/3019</a></li>
</ul>
<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn2"><p><a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-trusted-substituters"><code>trusted-substituters</code> — <code>nix.conf</code> reference</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><blockquote>
<p>A configuration setting usually overrides any previous value.
However, for settings that take a list of items, you can prefix the name of the setting
by <code>extra-</code> to append to the previous value.</p>
<p>— <a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#file-format"><code>nix.conf</code> reference</a></p>
</blockquote>
<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn4"><p><a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-substituters"><code>substituters</code> — <code>nix.conf</code> reference</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>See <code>nixConfig</code> in <a href="https://nix.dev/manual/nix/2.18/command-ref/new-cli/nix3-flake.html#flake-format%3E">Flake format — Nix Flake reference</a><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
  <footer>
    <p>
      
      <a href="/troubleshooting-lightdms-test-mode">Troubleshooting LightDM's test mode - Previous</a>
      
      |
      
      <span>Newest</span>
      
      
    </p>
  </footer>
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ielliott'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  </section>
  <footer>
  <div class="footer-item">
    <span>Isaac Elliott</span>
  </div>

  <div class="footer-item">
    <a class="footer-link-icon" href="https://github.com/lightandlight">
      <i class="footer-icon" data-feather="github"></i>
    </a>
    <a class="footer-link-name" href="https://github.com/lightandlight">
      GitHub
    </a>
  </div>

  <div class="footer-item">
    <a class="footer-link-icon" href="mailto:isaace71295@gmail.com">
      <i class="footer-icon" data-feather="mail"></i>
    </a>
    <a class="footer-link-name" href="mailto:isaace71295@gmail.com">
      Email
    </a>
  </div>

  <div class="footer-item">
    <a class="footer-link-icon" style="text-decoration: none;" href="https://blog.ielliott.io/feed.xml">
      <i class="footer-icon" data-feather="rss"></i>
    </a>
    <a class="footer-link-name" href="https://blog.ielliott.io/feed.xml">
      Atom
    </a>
  </div>
</footer>

  <script>feather.replace()</script>
</body>

</html>