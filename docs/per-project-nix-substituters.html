<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preload" href="/fonts/SourceSerif4/SourceSerif4-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/SourceSans3/SourceSans3-Regular.woff2" as="font" type="font/woff2" crossorigin>

  <link rel="stylesheet" href="/res/fonts.css">
  <link rel="stylesheet" href="/res/style.css">

  <!-- defer non-critical stylesheet -->
  <link href="/res/syntax.css" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/res/syntax.css"></noscript>

  

  

  

  
  <title>Per-project Nix substituters - blog.ielliott.io</title>
  

  <link rel="canonical" href="https://blog.ielliott.io/per-project-nix-substituters">
<link rel="alternate" type="application/atom+xml" title="blog.ielliott.io" href="/feed.xml">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="blog.ielliott.io">
<meta property="og:url" content="https://blog.ielliott.io/per-project-nix-substituters">
<meta property="og:title" content="Per-project Nix substituters">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Per-project Nix substituters">


<meta name="author" content="Isaac Elliott">
<meta name="description" content="A lot of Nix projects end up with their own binary cache (also known as a " substituter"). Nix can be quite slow when it's configured to use many project-specific substituters, because it queries them all when checking if it needs to build a derivation. In a specific project, most of the other substituters Nix knows about are irrelevant, and querying them is wasted effort. My solution is to only enable https: cache.nixos.org globally, and to selectively enable other substituters while I'm working on a project that needs them. Here's how I do it.">
<meta property="og:description" content="A lot of Nix projects end up with their own binary cache (also known as a " substituter"). Nix can be quite slow when it's configured to use many project-specific substituters, because it queries them all when checking if it needs to build a derivation. In a specific project, most of the other substituters Nix knows about are irrelevant, and querying them is wasted effort. My solution is to only enable https: cache.nixos.org globally, and to selectively enable other substituters while I'm working on a project that needs them. Here's how I do it.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-08-10T00:00+00:00">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline":"Per-project Nix substituters",
  "author": {
    "@type":"Person",
    "name":"Isaac Elliott"
  },
  "datePublished":"2024-08-10T00:00+00:00",
  "dateModified":"2024-08-10T00:00+00:00",
  "description":"A lot of Nix projects end up with their own binary cache (also known as a "substituter").
Nix can be quite slow when it's configured to use many project-specific substituters,
because it queries them all when checking if it needs to build a derivation. In a specific
project, most of the other substituters Nix knows about are irrelevant, and querying them
is wasted effort. My solution is to only enable https://cache.nixos.org globally, and
to selectively enable other substituters while I'm working on a project that needs them.
Here's how I do it.",
  "mainEntityOfPage": {
    "@type":"WebPage",
    "@id":"https://blog.ielliott.io/per-project-nix-substituters"
  },
  "url": "https://blog.ielliott.io/per-project-nix-substituters"
}
</script>
</head>

<body>
  <header>
    <h1><a href="/">I E</a></h1>
    <nav>
      <ol>
        <li><a href="/">Home</a>
        <li><a href="/about">About</a>
        <li><a href="/resources">Resources</a>
      </ol>
    </nav>
  </header>

  <main>
    

    <article>
  <header>
    <h1>Per-project Nix substituters</h1>
    <p class="post-metadata">
      10 August, 2024
      
    </p>
  </header>
  <div id="toc">
<h3>Contents</h3>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#without-flakes">Without Flakes</a></li>
<li><a href="#with-flakes">With Flakes</a></li>
</ul>
</div>
<p>A lot of Nix projects end up with their own binary cache (also known as a “substituter”).
Nix can be quite slow when it’s configured to use many project-specific substituters<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>,
because it queries them all when checking if it needs to build a derivation. In a specific
project, most of the other substituters Nix knows about are irrelevant, and querying them
is wasted effort. My solution is to only enable <a href="https://cache.nixos.org" class="uri">https://cache.nixos.org</a> globally, and
to selectively enable other substituters while I’m working on a project that needs them.
Here’s how I do it.</p>
<h2 id="setup"><a href="#setup">Setup</a></h2>
<p>In <code>configuration.nix</code>, set the system’s trusted substituters<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>nix<span class="op">.</span>settings<span class="op">.</span>trusted<span class="op">-</span>substituters = <span class="op">[</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;https://cache.nixos.org/&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-1&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-2&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;...&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;substituter-N&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>nix<span class="op">.</span>settings<span class="op">.</span>trusted<span class="op">-</span>public<span class="op">-</span>keys = <span class="op">[</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-1&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-2&quot;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;...&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;other-public-key-N&quot;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span></code></pre></div>
<p>And set Nix’s default substituter:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>nix<span class="op">.</span>settings<span class="op">.</span>substituters = <span class="op">[</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;https://cache.nixos.org/&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span>;</span></code></pre></div>
<p>By default, only the substituters in <code>substituters</code> will be used by Nix.
<code>trusted-substituters</code> lists the substituters that regular users are allowed to use in Nix builds.</p>
<h2 id="without-flakes"><a href="#without-flakes">Without Flakes</a></h2>
<p>To enable other substituters, use the <code>NIX_CONFIG</code> environment variable
with the <code>extra-substituters</code><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a><sup>,</sup><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> setting:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">NIX_CONFIG</span><span class="op">=</span><span class="st">&quot;extra-substituters = substituter-42&quot;</span></span></code></pre></div>
<p>Or use <code>substituters</code> to override the system’s substituters:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">NIX_CONFIG</span><span class="op">=</span><span class="st">&quot;substituters = substituter-42&quot;</span></span></code></pre></div>
<p>If the substituters named in these local settings aren’t defined in the <code>trusted-substituters</code>
system setting,
then Nix will ignore them and print the following message:</p>
<pre><code>warning: ignoring untrusted substituter '{substituter URL}', you are not a trusted user.</code></pre>
<p>I use <a href="https://direnv.net/">direnv</a> to automatically set and unset <code>NIX_CONFIG</code> by putting the <code>export NIX_CONFIG=...</code>
command inside a <code>.envrc</code> in the project root.</p>
<h2 id="with-flakes"><a href="#with-flakes">With Flakes</a></h2>
<p>The <code>nixConfig</code> attribute can be used to set Nix configuration from inside a Flake<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixConfig</span>.<span class="va">extra-substituters</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;substituter-42&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">.</span>..;</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  outputs = <span class="op">.</span>..;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>By default, Nix will ask for permission to use the config specified by the Flake.
I use <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a> to automatically load and unload <a href="https://nix.dev/manual/nix/2.18/command-ref/new-cli/nix3-develop">Nix develop shells</a> when switching projects,
and the permission prompt <a href="https://github.com/direnv/direnv/issues/1022">breaks direnv on my shell</a>.</p>
<p>To work around this, I enable the <a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-accept-flake-config"><code>accept-flake-config</code></a> Nix option in my <code>configuration.nix</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nix<span class="op">.</span>extraOptions = <span class="st">''</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="st">  experimental-features = nix-command flakes</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="st">  accept-flake-config = true</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">''</span>;</span></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Some relevant discussions:</p>
<ul>
<li><a href="https://discourse.nixos.org/t/a-common-public-nix-cache/26998#many-caches-are-bad-2" class="uri">https://discourse.nixos.org/t/a-common-public-nix-cache/26998#many-caches-are-bad-2</a></li>
<li><a href="https://github.com/NixOS/nix/issues/3019" class="uri">https://github.com/NixOS/nix/issues/3019</a></li>
</ul>
<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn2"><p><a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-trusted-substituters"><code>trusted-substituters</code> — <code>nix.conf</code> reference</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><blockquote>
<p>A configuration setting usually overrides any previous value.
However, for settings that take a list of items, you can prefix the name of the setting
by <code>extra-</code> to append to the previous value.</p>
<p>— <a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#file-format"><code>nix.conf</code> reference</a></p>
</blockquote>
<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></li>
<li id="fn4"><p><a href="https://nix.dev/manual/nix/2.18/command-ref/conf-file#conf-substituters"><code>substituters</code> — <code>nix.conf</code> reference</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>See <code>nixConfig</code> in <a href="https://nix.dev/manual/nix/2.18/command-ref/new-cli/nix3-flake.html#flake-format%3E">Flake format — Nix Flake reference</a><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
  <p class="post-navigation">
    
    <a href="/troubleshooting-lightdms-test-mode" title="Previous post: Troubleshooting LightDM's test mode">← Troubleshooting LightDM's test mode</a>
    

    
    <a href="/sized-types-and-coinduction-in-safe-agda" title="Next post: Sized types and coinduction in Safe Agda">Sized types and coinduction in Safe Agda →</a>
    
  </p>
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ielliott'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>
  Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  </main>

  <footer>
    <span>Isaac Elliott</span>

    <ol>
      <li><a class="footer-item-link" href="https://github.com/lightandlight">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M208.31 75.68A59.78 59.78 0 0 0 202.93 28a8 8 0 0 0-6.93-4 59.75 59.75 0 0 0-48 24h-24a59.75 59.75 0 0 0-48-24 8 8 0 0 0-6.93 4 59.78 59.78 0 0 0-5.38 47.68A58.14 58.14 0 0 0 56 104v8a56.06 56.06 0 0 0 48.44 55.47A39.8 39.8 0 0 0 96 192v8H72a24 24 0 0 1-24-24 40 40 0 0 0-40-40 8 8 0 0 0 0 16 24 24 0 0 1 24 24 40 40 0 0 0 40 40h24v16a8 8 0 0 0 16 0v-40a24 24 0 0 1 48 0v40a8 8 0 0 0 16 0v-40a39.8 39.8 0 0 0-8.44-24.53A56.06 56.06 0 0 0 216 112v-8a58.14 58.14 0 0 0-7.69-28.32M200 112a40 40 0 0 1-40 40h-48a40 40 0 0 1-40-40v-8a41.74 41.74 0 0 1 6.9-22.48 8 8 0 0 0 1.1-7.69 43.8 43.8 0 0 1 .79-33.58 43.88 43.88 0 0 1 32.32 20.06 8 8 0 0 0 6.71 3.69h32.35a8 8 0 0 0 6.74-3.69 43.87 43.87 0 0 1 32.32-20.06 43.8 43.8 0 0 1 .77 33.58 8.09 8.09 0 0 0 1 7.65 41.7 41.7 0 0 1 7 22.52Z"></path></svg>
        GitHub
      </a>

      <li><a class="footer-item-link" href="mailto:blog@id.ielliott.io">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M224 48H32a8 8 0 0 0-8 8v136a16 16 0 0 0 16 16h176a16 16 0 0 0 16-16V56a8 8 0 0 0-8-8m-20.57 16L128 133.15 52.57 64ZM216 192H40V74.19l82.59 75.71a8 8 0 0 0 10.82 0L216 74.19z"></path></svg>
        Email
      </a>

      <li><a class="footer-item-link" href="https://blog.ielliott.io/feed.xml">
        <svg class="footer-item-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><path d="M224 192a8 8 0 0 1-16 0c0-79.4-64.6-144-144-144a8 8 0 0 1 0-16c88.22 0 160 71.78 160 160M64 104a8 8 0 0 0 0 16 72.08 72.08 0 0 1 72 72 8 8 0 0 0 16 0 88.1 88.1 0 0 0-88-88m4 72a12 12 0 1 0 12 12 12 12 0 0 0-12-12"></path></svg>
        Feed
      </a>
    </ol>
  </footer>

  
</body>

</html>